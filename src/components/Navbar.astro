---
import { Icon } from "astro-icon/components";
import { navBarConfig, siteConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import { LinkPreset, type NavBarLink } from "../types/config";
import { url } from "../utils/url-utils";
import LightDarkSwitch from "./LightDarkSwitch.svelte";
import Search from "./Search.svelte";
import DisplaySettings from "./widget/DisplaySettings.svelte";
import DropdownMenu from "./widget/DropdownMenu.astro";
import TranslateButton from "./widget/TranslateButton.svelte";
import NavMenuPanel from "./widget/NavMenuPanel.astro";

const className = Astro.props.class;

const navbarTransparentMode =
	siteConfig.wallpaper.mode === "fullscreen"
		? siteConfig.wallpaper.fullscreen?.navbar?.transparentMode || "semi"
		: siteConfig.wallpaper.banner?.navbar?.transparentMode || "semi";

const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "";

let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item;
	},
);
---
<div id="navbar" class="z-50 onload-animation" data-transparent-mode={navbarTransparentMode} data-is-home={isHomePage}>
  <div class="absolute h-8 left-0 right-0 -top-8 bg-[var(--card-bg)] transition"></div>
  <div class:list={[className, "!overflow-visible max-w-[var(--page-width)] h-[4.5rem] mx-auto flex items-center justify-between px-4"]}>
    <a href={url('/')} class="btn-plain scale-animation rounded-lg h-[3.25rem] px-5 font-bold active:scale-95 brand-link">
      <div class="flex flex-row text-[var(--primary)] items-center text-md gap-2">
        <Icon name="material-symbols:filter-vintage-outline" class="text-[1.75rem]" />
        <span class="brand-title text-[1.05rem] sm:text-[1.15rem]">
          {siteConfig.title}
        </span>
      </div>
    </a>
    <div class="hidden md:flex items-center space-x-2 xl:space-x-1 2xl:space-x-2 navbar-nav-links">
      {links.map((l) => <DropdownMenu link={l} />)}
    </div>
    <div class="flex items-center space-x-2 sm:space-x-1 md:space-x-0.5 navbar-buttons" id="navbar-buttons">
      <Search client:only="svelte"></Search>
      <TranslateButton client:only="svelte"></TranslateButton>
      {!siteConfig.themeColor.fixed && (
        <button aria-label="Display Settings" class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 px-2" id="display-settings-switch">
          <Icon name="material-symbols:palette-outline" class="text-[1.25rem]"></Icon>
        </button>
      )}
      <div class="hidden sm:block">
        <LightDarkSwitch client:only="svelte"></LightDarkSwitch>
      </div>
      <button aria-label="Menu" class="btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 md:hidden" id="nav-menu-switch">
        <Icon name="material-symbols:menu-rounded" class="text-[1.25rem]"></Icon>
      </button>
    </div>
    <DisplaySettings client:only="svelte"></DisplaySettings>
    <NavMenuPanel links={links}></NavMenuPanel>
  </div>
</div>

<style>
  .navbar-nav-links { min-width: 0; flex-shrink: 1; }
  .navbar-buttons { min-width: 0; flex-shrink: 0; }
  @media (max-width: 640px) {
    #navbar > div {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
      border: 1px solid rgb(255 255 255 / 0.35);
      box-shadow: 0 6px 25px rgb(0 0 0 / 0.15);
    }
    #navbar .brand-link {
      padding-left: 0.35rem;
      padding-right: 0.35rem;
    }
    #navbar .brand-title {
      font-size: 0.95rem;
      line-height: 1.15rem;
    }
    #navbar .navbar-buttons {
      gap: 0.35rem;
    }
    #navbar .navbar-buttons > button {
      min-width: 2.8rem;
      min-height: 2.8rem;
    }
  }
</style>

<script>
// @ts-nocheck

let semifullScrollHandler;
const hoverTimers = new WeakMap();

function bindDropdowns() {
  const dropdowns = document.querySelectorAll('[data-dropdown]');
  dropdowns.forEach((dropdown) => {
    if (dropdown.dataset.bound === '1') return;
    dropdown.dataset.bound = '1';
    const trigger = dropdown.querySelector('[data-dropdown-trigger]');
    const menu = dropdown.querySelector('[data-dropdown-menu]');
    const items = dropdown.querySelectorAll('.dropdown-item');
    if (!trigger || !menu) return;

    const clearHoverTimer = () => {
      const timer = hoverTimers.get(dropdown);
      if (timer) {
        clearTimeout(timer);
        hoverTimers.delete(dropdown);
      }
    };
    const scheduleClose = (delay = 220) => {
      clearHoverTimer();
      const timer = setTimeout(() => {
        closeDropdown(dropdown, trigger, menu);
      }, delay);
      hoverTimers.set(dropdown, timer);
    };
    const openNow = () => {
      clearHoverTimer();
      openDropdown(dropdown, trigger, menu);
    };

    dropdown.addEventListener('mouseenter', openNow);
    dropdown.addEventListener('mouseleave', () => scheduleClose());
    trigger.addEventListener('focus', openNow);
    menu.addEventListener('focusin', clearHoverTimer);
    menu.addEventListener('mouseleave', () => scheduleClose());

    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      const expanded = trigger.getAttribute('aria-expanded') === 'true';
      if (expanded) scheduleClose(100); else openNow();
    });

    trigger.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleDropdown(dropdown, trigger, menu);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        openNow();
        if (items.length > 0) items[0].focus();
      } else if (e.key === 'Escape') {
        closeDropdown(dropdown, trigger, menu);
      }
    });

    items.forEach((item, index) => {
      item.addEventListener('mouseenter', clearHoverTimer);
      item.addEventListener('mouseleave', () => scheduleClose());
      item.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          items[(index + 1) % items.length].focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          items[(index - 1 + items.length) % items.length].focus();
        } else if (e.key === 'Escape') {
          closeDropdown(dropdown, trigger, menu);
          trigger.focus();
        }
      });
    });
  });

  if (!window.__navbarDropdownDocClickBound) {
    document.addEventListener('click', (event) => {
      document.querySelectorAll('[data-dropdown]').forEach((dropdown) => {
        if (!dropdown.contains(event.target)) {
          const trigger = dropdown.querySelector('[data-dropdown-trigger]');
          const menu = dropdown.querySelector('[data-dropdown-menu]');
          if (trigger && menu) closeDropdown(dropdown, trigger, menu);
        }
      });
    });
    window.__navbarDropdownDocClickBound = true;
  }
}

function closeAllDropdowns() {
  document.querySelectorAll('[data-dropdown]').forEach((dropdown) => {
    const trigger = dropdown.querySelector('[data-dropdown-trigger]');
    const menu = dropdown.querySelector('[data-dropdown-menu]');
    if (trigger && menu) closeDropdown(dropdown, trigger, menu);
  });
}

function toggleDropdown(dropdown, trigger, menu) {
  const isOpen = trigger.getAttribute('aria-expanded') === 'true';
  if (isOpen) closeDropdown(dropdown, trigger, menu); else openDropdown(dropdown, trigger, menu);
}
function openDropdown(dropdown, trigger, menu) {
  trigger.setAttribute('aria-expanded', 'true');
  menu.classList.remove('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-4px]');
  menu.classList.add('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
}
function closeDropdown(dropdown, trigger, menu) {
  trigger.setAttribute('aria-expanded', 'false');
  menu.classList.add('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-4px]');
  menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
}

function bindDisplaySettings() {
  const btn = document.getElementById('display-settings-switch');
  const panel = document.getElementById('display-setting');
  if (!btn || !panel) return;
  if (btn.dataset.bound === '1') return;
  btn.addEventListener('click', () => {
    panel.classList.toggle('float-panel-closed');
  });
  btn.dataset.bound = '1';
}

function bindNavMenu() {
  const btn = document.getElementById('nav-menu-switch');
  const panel = document.getElementById('nav-menu-panel');
  if (!btn || !panel) return;
  if (btn.dataset.bound === '1') return;
  btn.addEventListener('click', (event) => {
    event.preventDefault();
    panel.classList.toggle('float-panel-closed');
  });
  btn.dataset.bound = '1';

  if (!window.__navMenuOutsideHandler) {
    window.__navMenuOutsideHandler = (event) => {
      if (!panel.contains(event.target) && event.target !== btn && !btn.contains(event.target)) {
        panel.classList.add('float-panel-closed');
      }
    };
    document.addEventListener('click', window.__navMenuOutsideHandler);
  }
}

function updateNavbarIsHome() {
  const navbar = document.getElementById('navbar');
  if (!navbar) return;
  const isHome =
    document.body.classList.contains('lg:is-home') ||
    window.location.pathname === '/' ||
    window.location.pathname === '';
  navbar.setAttribute('data-is-home', String(isHome));
}

function initSemifullScrollDetection() {
  const navbar = document.getElementById('navbar');
  if (!navbar) return;
  const transparentMode = navbar.getAttribute('data-transparent-mode');
  if (transparentMode !== 'semifull') return;

  if (semifullScrollHandler) {
    window.removeEventListener('scroll', semifullScrollHandler);
    semifullScrollHandler = undefined;
  }

  updateNavbarIsHome();
  const isHome = navbar.getAttribute('data-is-home') === 'true';
  const threshold = 12;
  const applyScrolledState = (active) => {
    if (active) navbar.classList.add('scrolled'); else navbar.classList.remove('scrolled');
  };
  if (!isHome) { applyScrolledState(true); return; }

  let ticking = false;
  function updateNavbarState() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    applyScrolledState(scrollTop > threshold);
    ticking = false;
  }
  function requestTick() {
    if (!ticking) {
      requestAnimationFrame(updateNavbarState);
      ticking = true;
    }
  }

  semifullScrollHandler = requestTick;
  window.addEventListener('scroll', requestTick, { passive: true });
  updateNavbarState();
}

function initNavbar() {
  bindDropdowns();
  bindDisplaySettings();
  bindNavMenu();
  initSemifullScrollDetection();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initNavbar);
} else {
  initNavbar();
}

if (window?.swup?.hooks) {
  window.swup.hooks.on('visit:start', () => { closeAllDropdowns(); });
  window.swup.hooks.on('page:view', () => { requestAnimationFrame(initNavbar); });
}
</script>

{import.meta.env.PROD && <script is:inline define:vars={{scriptUrl: url('/pagefind/pagefind.js')}}>
async function loadPagefind() {
  try {
    const response = await fetch(scriptUrl, { method: 'HEAD' });
    if (!response.ok) throw new Error(`Pagefind script not found: ${response.status}`);
    const pagefind = await import(scriptUrl);
    await pagefind.options({ excerptLength: 20 });
    window.pagefind = pagefind;
    document.dispatchEvent(new CustomEvent('pagefindready'));
  } catch (error) {
    console.error('Failed to load Pagefind:', error);
    window.pagefind = {
      search: () => Promise.resolve({ results: [] }),
      options: () => Promise.resolve(),
    };
    document.dispatchEvent(new CustomEvent('pagefindloaderror'));
  }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadPagefind);
} else {
  loadPagefind();
}
</script>}
