---
import type { CollectionEntry } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { formatDateToYYYYMMDD } from "@utils/date-utils";
import { Icon } from "astro-icon/components";
import { siteConfig } from "@/config";

const { page } = Astro.props;

const interval = 40;

function getMonthLabel(monthNumber: number): string {
	const lang = (siteConfig.lang || "en").toLowerCase();
	if (lang.startsWith("zh")) {
		return `${monthNumber}月`;
	}
	if (lang.startsWith("ja")) {
		return `${monthNumber}月`;
	}
	if (lang.startsWith("ko")) {
		return `${monthNumber}월`;
	}
	const monthNames = [
		"Jan",
		"Feb",
		"Mar",
		"Apr",
		"May",
		"Jun",
		"Jul",
		"Aug",
		"Sep",
		"Oct",
		"Nov",
		"Dec",
	];
	if (!Number.isFinite(monthNumber) || monthNumber < 1 || monthNumber > 12) {
		return monthNumber.toString();
	}
	return monthNames[
		Math.max(0, Math.min(monthNames.length - 1, monthNumber - 1))
	];
}

const notes = await Promise.all(
	page.data.map(async (entry: CollectionEntry<"notes">) => {
		const { Content } = await entry.render();
		const publishedLabel = formatDateToYYYYMMDD(entry.data.published);
		const updatedLabel =
			entry.data.updated &&
			entry.data.updated.getTime() !== entry.data.published.getTime()
				? formatDateToYYYYMMDD(entry.data.updated)
				: null;
		const [year, month, day] = publishedLabel.split("-");
		const monthNumber = Number.parseInt(month, 10);
		const dayNumber = Number.parseInt(day, 10);
		const monthLabel =
			Number.isFinite(monthNumber) && monthNumber >= 1 && monthNumber <= 12
				? getMonthLabel(monthNumber)
				: month;
		const dayLabel = Number.isFinite(dayNumber)
			? dayNumber.toString().padStart(2, "0")
			: day;

		return {
			entry,
			Content,
			publishedLabel,
			updatedLabel,
			dateParts: {
				year,
				month: monthLabel,
				day: dayLabel,
			},
		};
	}),
);
---

<ul class="note-timeline">
    {notes.map((item, index) => {
        const Content = item.Content;
        const updatedDateTime = item.entry.data.updated?.toISOString();

        return (
            <li
                class:list={[
                    "note-timeline__item onload-animation",
                    item.entry.data.pinned ? "note-timeline__item--pinned" : "",
                ]}
                style={`animation-delay: calc(var(--content-delay) + ${index * interval}ms);`}
            >
                <div class="note-timeline__time">
                    <span class="note-timeline__day">{item.dateParts.day}</span>
                    <span class="note-timeline__month">{item.dateParts.month}</span>
                    <span class="note-timeline__year">{item.dateParts.year}</span>
                </div>

                <div class="note-timeline__axis" aria-hidden="true">
                    <span
                        class:list={[
                            "note-timeline__dot",
                            item.entry.data.pinned ? "note-timeline__dot--pinned" : "",
                        ]}
                    ></span>
                </div>

                <article class="note-timeline__card card-base">
                    {(item.entry.data.pinned || item.updatedLabel) && (
                        <header class="note-timeline__meta">
                            {item.entry.data.pinned && (
                                <span class="note-timeline__badge">
                                    <Icon
                                        name="material-symbols:push-pin"
                                        class="note-timeline__badge-icon"
                                    />
                                    {i18n(I18nKey.pinned)}
                                </span>
                            )}

                            {item.updatedLabel && updatedDateTime && (
                                <time
                                    datetime={updatedDateTime}
                                    class="note-timeline__meta-updated"
                                >
                                    <Icon name="material-symbols:history" />
                                    {item.updatedLabel}
                                </time>
                            )}
                        </header>
                    )}

                    <div class="note-timeline__body" data-pagefind-body>
                        <Markdown class="note-timeline__markdown">
                            <Content />
                        </Markdown>
                    </div>
                </article>
            </li>
        );
    })}
</ul>

<style>
.note-timeline {
    --note-timeline-accent: color-mix(in srgb, var(--primary) 82%, white 18%);
    list-style: none;
    padding: 0;
    margin: 0 0 clamp(2.75rem, 4vw, 3.5rem);
    display: flex;
    flex-direction: column;
    gap: clamp(1.75rem, 2.4vw, 2.65rem);
}

.note-timeline__item {
    display: grid;
    grid-template-columns: minmax(4.5rem, auto) 2.5rem minmax(0, 1fr);
    column-gap: clamp(1.1rem, 2vw, 1.75rem);
    align-items: stretch;
    min-width: 0;
}

.note-timeline__card {
    display: flex;
    flex-direction: column;
    gap: clamp(0.8rem, 1.8vw, 1.35rem);
    padding: clamp(1.1rem, 2.4vw, 1.85rem) clamp(1.2rem, 3vw, 2.45rem);
    border: 1px solid color-mix(in srgb, var(--note-timeline-accent) 28%, transparent);
    background: color-mix(
        in srgb,
        var(--card-bg) 98%,
        color-mix(in srgb, var(--primary) 8%, transparent)
    );
    backdrop-filter: blur(18px);
    box-shadow: 0 18px 42px -38px rgba(0, 0, 0, 0.65);
    transition: border-color 0.25s ease, box-shadow 0.25s ease, transform 0.3s ease;
    position: relative;
}

.note-timeline__item:hover .note-timeline__card,
.note-timeline__item:focus-within .note-timeline__card {
    transform: translateY(-4px);
    border-color: color-mix(in srgb, var(--note-timeline-accent) 45%, transparent);
    box-shadow: 0 30px 54px -42px rgba(15, 23, 42, 0.55);
}

.note-timeline__item--pinned .note-timeline__card {
    border-color: color-mix(in srgb, var(--primary) 50%, transparent);
    background: color-mix(
        in srgb,
        var(--card-bg) 94%,
        color-mix(in srgb, var(--primary) 22%, transparent)
    );
}

.note-timeline__time {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: flex-start;
    gap: 0.25rem;
    padding-top: 0.2rem;
    color: color-mix(in srgb, var(--note-timeline-accent) 75%, var(--foreground, #000) 25%);
    text-align: right;
    font-feature-settings: "tnum";
}

.note-timeline__day {
    font-size: clamp(1.9rem, 2.2vw + 1rem, 2.65rem);
    font-weight: 700;
    letter-spacing: -0.04em;
}

.note-timeline__month {
    font-size: clamp(0.85rem, 0.55vw + 0.75rem, 1rem);
    opacity: 0.75;
    font-weight: 500;
}

.note-timeline__year {
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    opacity: 0.55;
}

.note-timeline__axis {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: stretch;
}

.note-timeline__axis::before {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(
        to bottom,
        color-mix(in srgb, var(--note-timeline-accent) 15%, transparent),
        color-mix(in srgb, var(--note-timeline-accent) 45%, transparent)
    );
}

.note-timeline__item:first-child .note-timeline__axis::before {
    top: 50%;
}

.note-timeline__item:last-child .note-timeline__axis::before {
    bottom: 50%;
}

.note-timeline__item:first-child:last-child .note-timeline__axis::before {
    display: none;
}

.note-timeline__dot {
    position: relative;
    margin-top: 0.35rem;
    align-self: flex-start;
    width: 0.85rem;
    height: 0.85rem;
    border-radius: 50%;
    background: color-mix(in srgb, var(--note-timeline-accent) 75%, white 10%);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--card-bg) 75%, transparent);
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}

.note-timeline__dot::after {
    content: "";
    position: absolute;
    inset: -5px;
    border-radius: inherit;
    background: color-mix(in srgb, var(--note-timeline-accent) 30%, transparent);
    opacity: 0;
    transition: opacity 0.25s ease;
}

.note-timeline__item:hover .note-timeline__dot,
.note-timeline__item:focus-within .note-timeline__dot {
    transform: scale(1.15);
    box-shadow: 0 0 0 4px color-mix(in srgb, var(--note-timeline-accent) 35%, transparent);
}

.note-timeline__item:hover .note-timeline__dot::after,
.note-timeline__item:focus-within .note-timeline__dot::after {
    opacity: 1;
}

.note-timeline__dot--pinned {
    background: color-mix(in srgb, var(--primary) 86%, white 5%);
}

.note-timeline__badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--primary) 18%, transparent);
    color: color-mix(in srgb, var(--primary) 90%, white 10%);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.06em;
}

.note-timeline__badge-icon {
    font-size: 0.95rem;
}

.note-timeline__meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
}

.note-timeline__meta-updated {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
    color: color-mix(in srgb, var(--note-timeline-accent) 75%, transparent);
    border-radius: 999px;
    padding: 0.25rem 0.6rem;
    background: color-mix(in srgb, var(--note-timeline-accent) 15%, transparent);
}

.note-timeline__meta-updated :global(svg) {
    font-size: 1rem;
}

.note-timeline__body {
    position: relative;
}

.note-timeline__markdown {
    font-size: clamp(0.95rem, 0.45vw + 0.82rem, 1.05rem);
    line-height: 1.68;
    max-height: 22rem;
    overflow-y: auto;
    padding-right: 0.25rem;
}

.note-timeline__markdown :global(p:first-of-type) {
    font-size: clamp(1rem, 0.5vw + 0.95rem, 1.1rem);
    font-weight: 500;
    color: color-mix(in srgb, var(--foreground, var(--primary)) 75%, transparent);
}

.note-timeline__markdown::-webkit-scrollbar {
    width: 6px;
}

.note-timeline__markdown::-webkit-scrollbar-thumb {
    background-color: color-mix(in srgb, var(--note-timeline-accent) 32%, transparent);
    border-radius: 999px;
}

:global(.dark) .note-timeline {
    --note-timeline-accent: color-mix(in srgb, var(--primary) 70%, white 8%);
}

:global(.dark) .note-timeline__month {
    opacity: 0.8;
}

:global(.dark) .note-timeline__dot {
    box-shadow: 0 0 0 3px color-mix(in srgb, black 55%, transparent);
}

:global(.dark) .note-timeline__card {
    background: color-mix(
        in srgb,
        var(--card-bg) 88%,
        color-mix(in srgb, var(--primary) 22%, transparent)
    );
}

@media (max-width: 768px) {
    .note-timeline__item {
        grid-template-columns: minmax(3.2rem, auto) 1.5rem minmax(0, 1fr);
        column-gap: 0.85rem;
        padding: 0.75rem 0;
        align-items: stretch;
    }

    .note-timeline__time {
        align-items: center;
        text-align: center;
        padding: 0.65rem 0.25rem;
        border-radius: 1.15rem;
        background: linear-gradient(160deg,
            color-mix(in srgb, var(--note-timeline-accent) 28%, transparent) 0%,
            color-mix(in srgb, var(--note-timeline-accent) 10%, transparent) 100%);
        box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--note-timeline-accent) 30%, transparent);
    }

    .note-timeline__day {
        font-size: 1.65rem;
        letter-spacing: 0.05em;
        font-weight: 700;
    }

    .note-timeline__month {
        font-size: 0.95rem;
        font-weight: 600;
    }

    .note-timeline__year {
        font-size: 0.65rem;
        letter-spacing: 0.15em;
        opacity: 0.7;
        text-transform: uppercase;
    }

    .note-timeline__axis {
        display: flex;
        justify-content: center;
        align-items: stretch;
    }

    .note-timeline__card {
        padding: clamp(1rem, 4vw, 1.65rem) clamp(1rem, 5vw, 1.9rem);
        border: 1px solid color-mix(in srgb, var(--note-timeline-accent) 28%, transparent);
        box-shadow: 0 22px 50px -30px rgba(7, 15, 28, 0.2);
        border-radius: 1.25rem;
    }
}

:global(.dark) .note-timeline__meta-updated {
    background: color-mix(in srgb, var(--note-timeline-accent) 18%, transparent);
}
</style>

