---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import { LinkPreset, type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	link: NavBarLink;
	class?: string;
}

const { link, class: className } = Astro.props;

const processedLink = {
	...link,
	children: link.children?.map((child: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof child === "number") {
			return LinkPresets[child];
		}
		return child;
	}),
};

const hasChildren = processedLink.children && processedLink.children.length > 0;
---

<div class:list={["dropdown-container", "relative", className]} data-dropdown>
	{hasChildren ? (
		<button 
			class="btn-plain scale-animation rounded-lg h-11 font-bold px-3 active:scale-95 dropdown-trigger"
			aria-expanded="false"
			aria-haspopup="true"
			data-dropdown-trigger
		>
			<div class="flex items-center">
				{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] mr-2" />}
				<span class="dropdown-text hidden lg:inline" data-i18n-key={processedLink.i18nKey}>
					{processedLink.name}
				</span>
				<Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-[1.25rem] transition-transform duration-200 dropdown-arrow ml-1" />
			</div>
		</button>
		<div class="dropdown-menu absolute top-full left-0 pt-3 opacity-0 invisible pointer-events-none transition-all duration-200 ease-out transform translate-y-[-4px] z-50" data-dropdown-menu>
			<div class="dropdown-content bg-[var(--float-panel-bg)] rounded-[var(--radius-large)] shadow-xl dark:shadow-none border border-black/5 dark:border-white/10 py-2 min-w-[12rem]">
				{processedLink.children?.map((child) => (
					<a 
						href={child.external ? child.url : url(child.url)} 
						target={child.external ? "_blank" : null}
						class="dropdown-item flex items-center justify-between px-3 py-2 text-sm text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition-colors duration-150 font-medium first:rounded-t-[calc(var(--radius-large)-0.5rem)] last:rounded-b-[calc(var(--radius-large)-0.5rem)]"
						aria-label={child.name}
						data-i18n-key={child.i18nKey}
						data-i18n-attr="aria-label"
					>
						<div class="flex items-center">
							{child.icon && <Icon name={child.icon} class="text-[1rem] mr-2" />}
							<span data-i18n-key={child.i18nKey}>{child.name}</span>
						</div>
						{child.external && (
							<Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.75rem] text-black/25 dark:text-white/25" />
						)}
					</a>
				))}
			</div>
		</div>
	) : (
		<a 
			aria-label={processedLink.name} 
			href={processedLink.external ? processedLink.url : url(processedLink.url)} 
			target={processedLink.external ? "_blank" : null}
			class="btn-plain scale-animation rounded-lg h-11 font-bold px-3 active:scale-95 nav-link-item"
			data-i18n-key={processedLink.i18nKey}
			data-i18n-attr="aria-label"
			data-link-name={processedLink.name}
		>
			<div class="flex items-center">
				{processedLink.icon && <Icon name={processedLink.icon} class="text-[1.1rem] nav-link-icon" />}
				<span class="nav-link-text ml-2 hidden lg:inline" data-i18n-key={processedLink.i18nKey}>
					{processedLink.name}
				</span>
				{processedLink.external && <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]" />}
			</div>
		</a>
	)}
</div>

<style>
	.dropdown-container::before {
		content: "";
		position: absolute;
		left: -6px;
		right: -6px;
		top: 100%;
		height: 18px;
		pointer-events: auto;
	}

	.dropdown-container:hover .dropdown-arrow,
	.dropdown-container:focus-within .dropdown-arrow {
		transform: rotate(180deg);
	}

	@media (max-width: 1023px) {
		.nav-link-item {
			padding-left: 0.5rem;
			padding-right: 0.5rem;
		}

		.nav-link-text,
		.dropdown-text {
			display: none;
		}
	}

	@media (min-width: 1024px) {
		.nav-link-item {
			padding-left: 0.75rem;
			padding-right: 0.75rem;
		}

		.nav-link-text,
		.dropdown-text {
			display: inline;
		}
	}
</style>

<script>
// @ts-nocheck

const hoverTimers = new WeakMap();

document.addEventListener('DOMContentLoaded', () => {
	const dropdowns = document.querySelectorAll('[data-dropdown]');

	dropdowns.forEach((dropdown) => {
		const trigger = dropdown.querySelector('[data-dropdown-trigger]');
		const menu = dropdown.querySelector('[data-dropdown-menu]');
		const items = dropdown.querySelectorAll('.dropdown-item');

		if (!trigger || !menu) {
			return;
		}

		const clearHoverTimer = () => {
			const timer = hoverTimers.get(dropdown);
			if (timer) {
				clearTimeout(timer);
				hoverTimers.delete(dropdown);
			}
		};

		const scheduleClose = (delay = 180) => {
			clearHoverTimer();
			const timer = setTimeout(() => {
				closeDropdown(dropdown, trigger, menu);
			}, delay);
			hoverTimers.set(dropdown, timer);
		};

		const openNow = () => {
			clearHoverTimer();
			openDropdown(dropdown, trigger, menu);
		};

		dropdown.addEventListener('mouseenter', openNow);
		dropdown.addEventListener('mouseleave', () => scheduleClose());
		trigger.addEventListener('focus', openNow);
		menu.addEventListener('focusin', clearHoverTimer);
		menu.addEventListener('mouseleave', () => scheduleClose());

		trigger.addEventListener('click', (event) => {
			event.preventDefault();
			const expanded = trigger.getAttribute('aria-expanded') === 'true';
			if (expanded) {
				scheduleClose(80);
			} else {
				openNow();
			}
		});

		trigger.addEventListener('keydown', (event) => {
			if (event.key === 'Enter' || event.key === ' ') {
				event.preventDefault();
				toggleDropdown(dropdown, trigger, menu);
			} else if (event.key === 'ArrowDown') {
				event.preventDefault();
				openNow();
				if (items.length > 0) {
					items[0].focus();
				}
			} else if (event.key === 'Escape') {
				closeDropdown(dropdown, trigger, menu);
			}
		});

		items.forEach((item, index) => {
			item.addEventListener('mouseenter', clearHoverTimer);
			item.addEventListener('mouseleave', () => scheduleClose());
			item.addEventListener('keydown', (event) => {
				if (event.key === 'ArrowDown') {
					event.preventDefault();
					const nextIndex = (index + 1) % items.length;
					items[nextIndex].focus();
				} else if (event.key === 'ArrowUp') {
					event.preventDefault();
					const prevIndex = (index - 1 + items.length) % items.length;
					items[prevIndex].focus();
				} else if (event.key === 'Escape') {
					closeDropdown(dropdown, trigger, menu);
					trigger.focus();
				}
			});
		});

		menu.addEventListener('keyup', (event) => {
			if (event.key === 'Tab' && !menu.contains(document.activeElement)) {
				scheduleClose(120);
			}
		});
	});

	document.addEventListener('click', (event) => {
		dropdowns.forEach((dropdown) => {
			if (!dropdown.contains(event.target)) {
				const trigger = dropdown.querySelector('[data-dropdown-trigger]');
				const menu = dropdown.querySelector('[data-dropdown-menu]');
				if (trigger && menu) {
					closeDropdown(dropdown, trigger, menu);
				}
			}
		});
	});
});

function toggleDropdown(dropdown, trigger, menu) {
	const isOpen = trigger.getAttribute('aria-expanded') === 'true';
	if (isOpen) {
		closeDropdown(dropdown, trigger, menu);
	} else {
		openDropdown(dropdown, trigger, menu);
	}
}

function openDropdown(dropdown, trigger, menu) {
	trigger.setAttribute('aria-expanded', 'true');
	menu.classList.remove('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-4px]');
	menu.classList.add('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
}

function closeDropdown(dropdown, trigger, menu) {
	trigger.setAttribute('aria-expanded', 'false');
	menu.classList.add('opacity-0', 'invisible', 'pointer-events-none', 'translate-y-[-4px]');
	menu.classList.remove('opacity-100', 'visible', 'pointer-events-auto', 'translate-y-0');
}
</script>
